import { join, } from "@tauri-apps/api/path";
import { open as openDialog, } from "@tauri-apps/plugin-dialog";
import { exists, } from "@tauri-apps/plugin-fs";
import { useEffect, useRef, useState, } from "react";
import { detectObsidianFolders, } from "../../services/obsidian";
import { applyFilenamePattern, getJournalDir, initJournalScope, resetJournalDir, } from "../../services/paths";
import { DEFAULT_FILENAME_PATTERN, loadSettings, saveSettings, type Settings, } from "../../services/settings";
import { getToday, } from "../../types/note";
import { VaultPathMarquee, } from "../shared/VaultPathMarquee";

interface SettingsModalProps {
  open: boolean;
  onClose: () => void;
}

const FILENAME_PRESETS = [
  { label: "Flat", value: "{YYYY}-{MM}-{DD}", },
  { label: "By year", value: "{YYYY}/{YYYY}-{MM}-{DD}", },
  { label: "By year + month", value: "{YYYY}/{MM}/{YYYY}-{MM}-{DD}", },
];

const mono = { fontFamily: "'IBM Plex Mono', monospace", };

export function SettingsModal({ open, onClose, }: SettingsModalProps,) {
  const [settings, setSettings,] = useState<Settings | null>(null,);
  const [saved, setSaved,] = useState(false,);
  const [defaultJournalDir, setDefaultJournalDir,] = useState("",);
  const inputRef = useRef<HTMLInputElement>(null,);

  useEffect(() => {
    if (open) {
      loadSettings().then((s,) => {
        setSettings(s,);
        setSaved(false,);
      },);
      // Resolve the default journal dir for display
      getJournalDir().then(setDefaultJournalDir,);
      setTimeout(() => inputRef.current?.focus(), 100,);
    }
  }, [open,],);

  if (!open || !settings) return null;

  const effectivePattern = settings.filenamePattern || DEFAULT_FILENAME_PATTERN;
  const filenamePreview = applyFilenamePattern(effectivePattern, getToday(),) + ".md";

  const update = (partial: Partial<Settings>,) => {
    setSettings({ ...settings, ...partial, },);
    setSaved(false,);
  };

  const handleSave = async () => {
    try {
      const normalizedVault = settings.vaultDir.trim();
      const normalizedDaily = settings.dailyLogsFolder.trim();
      const nextSettings = {
        ...settings,
        vaultDir: normalizedVault,
        dailyLogsFolder: normalizedDaily,
        excalidrawFolder: settings.excalidrawFolder.trim(),
        assetsFolder: settings.assetsFolder.trim(),
        journalDir: normalizedVault && normalizedDaily
          ? await join(normalizedVault, normalizedDaily,)
          : settings.journalDir,
      };
      await saveSettings(nextSettings,);
      // Reset cached journal dir so it picks up the new setting
      await resetJournalDir(nextSettings.journalDir || undefined,);
      await initJournalScope();
      setSettings(nextSettings,);
      setSaved(true,);
      setTimeout(() => setSaved(false,), 2000,);
    } catch (err) {
      console.error("Failed to save settings:", err,);
    }
  };

  const detectFromVault = async (vaultDir: string,) => {
    const normalizedVaultDir = vaultDir.trim();
    if (!normalizedVaultDir) return;

    const detected = await detectObsidianFolders(normalizedVaultDir,);
    setSettings((current,) => {
      if (!current) return current;
      return {
        ...current,
        filenamePattern: detected.filenamePattern || current.filenamePattern,
        dailyLogsFolder: detected.dailyLogsFolder || current.dailyLogsFolder,
        excalidrawFolder: detected.excalidrawFolder || current.excalidrawFolder,
        assetsFolder: detected.assetsFolder || current.assetsFolder,
      };
    },);
    setSaved(false,);
  };

  const handleChooseVault = async () => {
    const defaultPath = (settings.vaultDir || settings.journalDir || defaultJournalDir).trim();
    const selected = await openDialog({
      directory: true,
      multiple: false,
      defaultPath: defaultPath && await exists(defaultPath,) ? defaultPath : undefined,
    },);
    if (selected) {
      update({ vaultDir: selected, },);
      await detectFromVault(selected,);
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent,) => {
    if (e.key === "Escape") {
      onClose();
    } else if (e.key === "Enter" && e.metaKey) {
      handleSave();
    }
  };

  return (
    <div
      className="fixed inset-0 z-[100] flex items-center justify-center"
      onClick={onClose}
      onKeyDown={handleKeyDown}
    >
      <div
        className="absolute top-0 left-0 right-0 h-[38px] z-[1]"
        data-tauri-drag-region
        onClick={(e,) => e.stopPropagation()}
      />
      {/* Backdrop */}
      <div className="absolute inset-0 bg-black/30 backdrop-blur-sm" />

      {/* Modal */}
      <div
        className="modal-scroll relative bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 p-6 max-h-[80vh] overflow-y-auto overflow-x-hidden"
        onClick={(e,) => e.stopPropagation()}
      >
        <div className="flex items-center justify-between mb-5">
          <h2 className="text-lg font-medium text-gray-900" style={mono}>
            Settings
          </h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 transition-colors text-lg cursor-pointer"
          >
            ✕
          </button>
        </div>

        {/* API Key */}
        <div className="space-y-3">
          <label className="block text-sm text-gray-600" style={mono}>
            Anthropic API Key
          </label>
          <input
            ref={inputRef}
            type="password"
            value={settings.anthropicApiKey}
            onChange={(e,) => update({ anthropicApiKey: e.target.value, },)}
            placeholder="sk-ant-..."
            className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-violet-500/30 focus:border-violet-400 transition-all"
            style={mono}
          />
          <p className="text-xs text-gray-400" style={mono}>
            Required for the Build feature. Stored locally on your device.
          </p>
        </div>

        {/* Divider */}
        <div className="my-5 border-t border-gray-100" />

        {/* Vault Settings */}
        <div className="space-y-3">
          <label className="block text-sm text-gray-600" style={mono}>
            Vault Location
          </label>
          <div className="flex items-center gap-2">
            <div
              className="flex-1 min-w-0 px-3 py-2 border border-gray-200 rounded-lg text-sm text-gray-500 bg-gray-50"
              style={mono}
              title={settings.vaultDir || settings.journalDir || defaultJournalDir}
            >
              <VaultPathMarquee
                path={settings.vaultDir || settings.journalDir || defaultJournalDir || "..."}
              />
            </div>
            <button
              onClick={handleChooseVault}
              className="shrink-0 px-3 py-2 text-sm border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer text-gray-700"
              style={mono}
            >
              Choose…
            </button>
          </div>
          {settings.vaultDir && (
            <button
              onClick={() => update({ vaultDir: "", },)}
              className="text-xs text-violet-600 hover:text-violet-800 transition-colors cursor-pointer"
              style={mono}
            >
              Reset to default
            </button>
          )}
          <label className="block text-sm text-gray-600 pt-2" style={mono}>
            Daily logs folder
          </label>
          <input
            type="text"
            value={settings.dailyLogsFolder}
            onChange={(e,) => update({ dailyLogsFolder: e.target.value, },)}
            placeholder="Daily Notes"
            className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-violet-500/30 focus:border-violet-400 transition-all"
            style={mono}
          />
          <label className="block text-sm text-gray-600 pt-2" style={mono}>
            Excalidraw folder (optional)
          </label>
          <input
            type="text"
            value={settings.excalidrawFolder}
            onChange={(e,) => update({ excalidrawFolder: e.target.value, },)}
            placeholder="Excalidraw"
            className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-violet-500/30 focus:border-violet-400 transition-all"
            style={mono}
          />
          <label className="block text-sm text-gray-600 pt-2" style={mono}>
            Assets folder (optional)
          </label>
          <input
            type="text"
            value={settings.assetsFolder}
            onChange={(e,) => update({ assetsFolder: e.target.value, },)}
            placeholder="assets"
            className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-violet-500/30 focus:border-violet-400 transition-all"
            style={mono}
          />
          <p className="text-xs text-gray-400" style={mono}>
            Philo uses these to resolve notes, `![[*.excalidraw]]` embeds, and pasted image paths inside your vault.
          </p>
          <p className="text-xs text-amber-600" style={mono}>
            Changing this will not move existing files.
          </p>
        </div>

        {/* Divider */}
        <div className="my-5 border-t border-gray-100" />

        {/* Filename Pattern */}
        <div className="space-y-3">
          <label className="block text-sm text-gray-600" style={mono}>
            Filename Pattern
          </label>
          <input
            type="text"
            value={settings.filenamePattern}
            onChange={(e,) => update({ filenamePattern: e.target.value, },)}
            placeholder={DEFAULT_FILENAME_PATTERN}
            className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-violet-500/30 focus:border-violet-400 transition-all"
            style={mono}
          />
          <div className="flex flex-wrap gap-1.5">
            {FILENAME_PRESETS.map((preset,) => (
              <button
                key={preset.value}
                onClick={() => update({ filenamePattern: preset.value, },)}
                className={`px-2 py-1 text-xs rounded-md border transition-colors cursor-pointer ${
                  effectivePattern === preset.value
                    ? "border-violet-400 bg-violet-50 text-violet-700"
                    : "border-gray-200 text-gray-500 hover:border-gray-300"
                }`}
                style={mono}
              >
                {preset.label}
              </button>
            ))}
          </div>
          <p className="text-xs text-gray-400" style={mono}>
            Preview: <span className="text-gray-600">{filenamePreview}</span>
          </p>
          <p className="text-xs text-gray-400" style={mono}>
            Tokens: {"{"}
            <span className="text-gray-600">YYYY</span>
            {"}"}, {"{"}
            <span className="text-gray-600">MM</span>
            {"}"}, {"{"}
            <span className="text-gray-600">DD</span>
            {"}"}. Use <span className="text-gray-600">/</span> for subdirectories.
          </p>
          <p className="text-xs text-amber-600" style={mono}>
            Changing this will not rename existing files.
          </p>
        </div>

        {/* Actions */}
        <div className="mt-6 flex justify-end gap-3">
          <button
            onClick={onClose}
            className="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 rounded-lg transition-colors cursor-pointer"
            style={mono}
          >
            Cancel
          </button>
          <button
            onClick={handleSave}
            className="px-4 py-2 text-sm text-white rounded-lg transition-all cursor-pointer"
            style={{
              ...mono,
              background: saved
                ? "linear-gradient(to bottom, #22c55e, #16a34a)"
                : "linear-gradient(to bottom, #7c3aed, #5b21b6)",
            }}
          >
            {saved ? "✓ Saved" : "Save"}
          </button>
        </div>
      </div>
    </div>
  );
}
